#!/bin/bash
set -euo pipefail

# Get the latest while trying to preserve any modifications
omarchy_path="$HOME/.local/share/omarchy"
git -C "$omarchy_path" pull --autostash
git -C "$omarchy_path" diff --check || git -C "$omarchy_path" reset --merge

# Run migrations
"$HOME/.local/share/omarchy/bin/omarchy-migrate"

# Update system packages
echo -e "\e[32m\nUpdate system packages\e[0m"
sudo dnf -y upgrade --refresh

# Offer to reboot if a newer kernel is installed than the one running
current_kernel="$(uname -r)"
latest_installed_kernel="$(rpm -q kernel --qf '%{VERSION}-%{RELEASE}.%{ARCH}\n' | sort -V | tail -1 || true)"

if [[ -n "$latest_installed_kernel" && "$current_kernel" != "$latest_installed_kernel" ]]; then
  gum confirm "Linux kernel has been updated. Reboot?" && sudo reboot now
fi
