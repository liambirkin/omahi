#!/bin/bash
set -e

if [[ "--remove" == "$1" ]]; then
  echo -e "\e[32mRemoving fingerprint auth for this user.\e[0m"
  # Fedora: removing packages is optional; usually you just delete enrolled prints
  sudo fprintd-delete "$USER" || true
  echo -e "\e[32mDone.\e[0m"
  exit 0
fi

echo -e "\e[32mInstalling fingerprint support and starting service…\e[0m"
sudo dnf -y install fprintd fprintd-pam
sudo systemctl enable --now fprintd.service || true

if fprintd-list "$USER" >/dev/null 2>&1; then
  echo -e "\e[33mA fingerprint is already enrolled for $USER.\e[0m"
else
  echo -e "\e[32m\nLet's enroll your right index finger.\nPlace and lift the finger until it completes.\e[0m"
  sudo fprintd-enroll "$USER"
fi

echo -e "\e[32m\nVerifying enrollment…\e[0m"
if fprintd-verify; then
  echo -e "\e[32m\nPerfect! You can use your fingerprint on the lock screen.\e[0m"
else
  echo -e "\e[31m\nSomething went wrong. Maybe try again?\e[0m"
fi
